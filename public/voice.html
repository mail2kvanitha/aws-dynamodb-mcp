<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HealthCarer Voice Assistant - Powered by Nova</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .voice-section {
            padding: 40px;
            text-align: center;
        }

        .voice-button {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .voice-button:hover {
            transform: scale(1.05);
        }

        .voice-button.listening {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            animation: pulse 1.5s infinite;
        }

        .voice-button.processing {
            background: linear-gradient(135deg, #ffa726 0%, #fb8c00 100%);
            animation: spin 2s linear infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .status-display {
            background: #f8f9fa;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            border-left: 4px solid #4facfe;
        }

        .conversation {
            background: #ffffff;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            max-height: 400px;
            overflow-y: auto;
        }

        .message {
            margin: 10px 0;
            padding: 15px;
            border-radius: 10px;
        }

        .user-message {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
        }

        .assistant-message {
            background: #f3e5f5;
            border-left: 4px solid #9c27b0;
        }

        .system-message {
            background: #e8f5e8;
            border-left: 4px solid #4caf50;
            font-style: italic;
        }

        .quick-commands {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .quick-command {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }

        .quick-command:hover {
            background: #e3f2fd;
            border-color: #2196f3;
        }

        .voice-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
        }

        .control-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .control-btn.primary {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .control-btn.secondary {
            background: #6c757d;
            color: white;
        }

        .settings {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .settings h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 10px 0;
        }

        select, input[type="range"] {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üé§ HealthCarer Voice Assistant</h1>
            <p>Powered by Nova - Speak naturally to manage appointments</p>
        </div>

        <div class="voice-section">
            <button id="voiceButton" class="voice-button" onclick="toggleVoice()">
                üé§
            </button>
            
            <div class="status-display">
                <h3 id="statusTitle">Ready to Help</h3>
                <p id="statusText">Click the microphone and say something like "Check availability for Carer1" or "Book an appointment"</p>
            </div>

            <div class="voice-controls">
                <button class="control-btn primary" onclick="initializeSystem()">Initialize System</button>
                <button class="control-btn secondary" onclick="clearConversation()">Clear History</button>
                <button class="control-btn secondary" onclick="toggleSettings()">Settings</button>
            </div>

            <div class="quick-commands">
                <div class="quick-command" onclick="speakCommand('Check availability for all carers')">
                    <strong>üìÖ Check Availability</strong><br>
                    <small>"Check availability for all carers"</small>
                </div>
                <div class="quick-command" onclick="speakCommand('Book an appointment with Carer1')">
                    <strong>üìù Book Appointment</strong><br>
                    <small>"Book an appointment with Carer1"</small>
                </div>
                <div class="quick-command" onclick="speakCommand('Cancel my appointment')">
                    <strong>‚ùå Cancel Appointment</strong><br>
                    <small>"Cancel my appointment"</small>
                </div>
                <div class="quick-command" onclick="speakCommand('What appointments do I have?')">
                    <strong>üìã My Appointments</strong><br>
                    <small>"What appointments do I have?"</small>
                </div>
            </div>

            <div class="conversation" id="conversation">
                <div class="system-message">
                    <strong>System:</strong> Welcome! I can help you manage healthcare appointments. Try saying:
                    <ul style="margin-top: 10px;">
                        <li>"Check availability for Carer1 tomorrow"</li>
                        <li>"Book an appointment with Carer2 at 2 PM"</li>
                        <li>"Cancel my appointment on January 25th"</li>
                        <li>"What time slots are available?"</li>
                    </ul>
                </div>
            </div>

            <div id="settings" class="settings hidden">
                <h3>‚öôÔ∏è Voice Settings</h3>
                <div class="setting-item">
                    <label>Speech Recognition Language:</label>
                    <select id="languageSelect">
                        <option value="en-US">English (US)</option>
                        <option value="en-GB">English (UK)</option>
                        <option value="en-AU">English (Australia)</option>
                    </select>
                </div>
                <div class="setting-item">
                    <label>Speech Speed:</label>
                    <input type="range" id="speechRate" min="0.5" max="2" step="0.1" value="1">
                    <span id="speedValue">1.0x</span>
                </div>
                <div class="setting-item">
                    <label>Voice Pitch:</label>
                    <input type="range" id="speechPitch" min="0" max="2" step="0.1" value="1">
                    <span id="pitchValue">1.0</span>
                </div>
                <div class="setting-item">
                    <label>Auto-speak responses:</label>
                    <input type="checkbox" id="autoSpeak" checked>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3000/api';
        
        // Voice recognition and synthesis
        let recognition;
        let synthesis = window.speechSynthesis;
        let isListening = false;
        let conversation = [];

        // Initialize speech recognition
        function initializeSpeechRecognition() {
            if ('webkitSpeechRecognition' in window) {
                recognition = new webkitSpeechRecognition();
            } else if ('SpeechRecognition' in window) {
                recognition = new SpeechRecognition();
            } else {
                showError('Speech recognition not supported in this browser. Please use Chrome or Edge.');
                return false;
            }

            recognition.continuous = false;
            recognition.interimResults = true;
            recognition.lang = document.getElementById('languageSelect').value;

            recognition.onstart = () => {
                isListening = true;
                updateVoiceButton('listening');
                updateStatus('Listening...', 'I\'m listening. Speak clearly about your appointment needs.');
            };

            recognition.onresult = (event) => {
                let transcript = '';
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    transcript += event.results[i][0].transcript;
                }
                
                if (event.results[event.results.length - 1].isFinal) {
                    processVoiceCommand(transcript);
                } else {
                    updateStatus('Listening...', `Hearing: "${transcript}"`);
                }
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                showError(`Speech recognition error: ${event.error}`);
                resetVoiceButton();
            };

            recognition.onend = () => {
                isListening = false;
                if (document.getElementById('voiceButton').classList.contains('listening')) {
                    resetVoiceButton();
                }
            };

            return true;
        }

        function toggleVoice() {
            if (!recognition && !initializeSpeechRecognition()) {
                return;
            }

            if (isListening) {
                recognition.stop();
                resetVoiceButton();
            } else {
                recognition.start();
            }
        }

        function updateVoiceButton(state) {
            const button = document.getElementById('voiceButton');
            button.className = `voice-button ${state}`;
            
            switch(state) {
                case 'listening':
                    button.innerHTML = 'üéß';
                    break;
                case 'processing':
                    button.innerHTML = '‚ö°';
                    break;
                default:
                    button.innerHTML = 'üé§';
            }
        }

        function resetVoiceButton() {
            updateVoiceButton('');
            updateStatus('Ready to Help', 'Click the microphone to start speaking');
        }

        function updateStatus(title, text) {
            document.getElementById('statusTitle').textContent = title;
            document.getElementById('statusText').textContent = text;
        }

        function addToConversation(type, message) {
            const conversationDiv = document.getElementById('conversation');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}-message`;
            messageDiv.innerHTML = `<strong>${type === 'user' ? 'You' : 'Assistant'}:</strong> ${message}`;
            conversationDiv.appendChild(messageDiv);
            conversationDiv.scrollTop = conversationDiv.scrollHeight;
            
            conversation.push({ type, message, timestamp: new Date() });
        }

        async function processVoiceCommand(transcript) {
            updateVoiceButton('processing');
            updateStatus('Processing...', `Understanding: "${transcript}"`);
            
            addToConversation('user', transcript);
            
            try {
                const response = await handleVoiceCommand(transcript.toLowerCase().trim());
                addToConversation('assistant', response);
                
                if (document.getElementById('autoSpeak').checked) {
                    speakResponse(response);
                }
                
                updateStatus('Command Completed', 'Ready for your next request');
            } catch (error) {
                const errorMsg = `Sorry, I encountered an error: ${error.message}`;
                addToConversation('assistant', errorMsg);
                showError(errorMsg);
            }
            
            resetVoiceButton();
        }

        async function handleVoiceCommand(command) {
            // Initialize system
            if (command.includes('initialize') || command.includes('setup') || command.includes('start system')) {
                await initializeSlots();
                return "I've initialized all the time slots in the system. You can now check availability and book appointments.";
            }

            // Check availability
            if (command.includes('check availability') || command.includes('show availability') || command.includes('what slots') || command.includes('available times')) {
                let carer = null;
                let date = null;

                // Extract carer
                if (command.includes('carer1') || command.includes('carer 1')) carer = 'Carer1';
                else if (command.includes('carer2') || command.includes('carer 2')) carer = 'Carer2';
                else if (command.includes('carer3') || command.includes('carer 3')) carer = 'Carer3';

                // Extract date
                if (command.includes('today') || command.includes('january 25')) date = '20250725';
                else if (command.includes('tomorrow') || command.includes('january 26')) date = '20250726';
                else if (command.includes('day after') || command.includes('january 27')) date = '20250727';

                const availability = await getAvailability(carer, date);
                return formatAvailabilityResponse(availability, carer, date);
            }

            // Book appointment
            if (command.includes('book') || command.includes('schedule') || command.includes('make appointment')) {
                return await handleBookingCommand(command);
            }

            // Cancel appointment
            if (command.includes('cancel') || command.includes('remove') || command.includes('delete appointment')) {
                return "To cancel an appointment, I need specific details. Please tell me the carer, date, and time. For example: 'Cancel my appointment with Carer1 on January 25th at 9 AM'";
            }

            // General help
            if (command.includes('help') || command.includes('what can you do')) {
                return `I can help you with healthcare appointments! Here's what I can do:

1. Check availability - "Check availability for Carer1"
2. Book appointments - "Book an appointment with Carer2 at 2 PM tomorrow"
3. Cancel appointments - "Cancel my appointment on January 25th"
4. Initialize system - "Initialize the system"

Just speak naturally and I'll understand what you need!`;
            }

            // Default response
            return `I heard you say: "${command}". I can help with checking availability, booking appointments, or canceling appointments. Could you please rephrase your request more specifically?`;
        }

        async function handleBookingCommand(command) {
            // This is a simplified booking flow - in practice, you'd want more sophisticated parsing
            let carer = null;
            let date = null;
            let time = null;

            // Extract carer
            if (command.includes('carer1') || command.includes('carer 1')) carer = 'Carer1';
            else if (command.includes('carer2') || command.includes('carer 2')) carer = 'Carer2';
            else if (command.includes('carer3') || command.includes('carer 3')) carer = 'Carer3';

            // Extract date
            if (command.includes('today') || command.includes('january 25')) date = '20250725';
            else if (command.includes('tomorrow') || command.includes('january 26')) date = '20250726';
            else if (command.includes('day after') || command.includes('january 27')) date = '20250727';

            // Extract time (simplified)
            if (command.includes('9 am') || command.includes('nine am')) time = '0900';
            else if (command.includes('2 pm') || command.includes('two pm')) time = '1400';
            else if (command.includes('10 am') || command.includes('ten am')) time = '1000';

            if (!carer || !date || !time) {
                return "To book an appointment, I need more details. Please specify the carer, date, and time. For example: 'Book an appointment with Carer1 tomorrow at 2 PM'";
            }

            // For demo purposes, using a default name
            const personName = "Voice User";
            
            try {
                const result = await bookAppointment(carer, date, time, personName);
                if (result.success) {
                    return `Great! I've successfully booked your appointment with ${carer} on ${formatDate(date)} at ${formatTime(time)}.`;
                } else {
                    return `Sorry, I couldn't book that appointment. ${result.message}`;
                }
            } catch (error) {
                return `There was an error booking your appointment: ${error.message}`;
            }
        }

        // API functions
        async function initializeSlots() {
            const response = await fetch(`${API_BASE}/initialize`, { method: 'POST' });
            const data = await response.json();
            if (!data.success) throw new Error(data.error);
            return data;
        }

        async function getAvailability(carer, date) {
            let url = `${API_BASE}/availability`;
            const params = new URLSearchParams();
            if (carer) params.append('carer_id', carer);
            if (date) params.append('date', date);
            if (params.toString()) url += '?' + params.toString();
            
            const response = await fetch(url);
            const data = await response.json();
            if (!data.success) throw new Error(data.error);
            return data.data;
        }

        async function bookAppointment(carer, date, time, name) {
            const response = await fetch(`${API_BASE}/book`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    carer_id: carer,
                    date: date,
                    time_slot: time,
                    person_name: name
                })
            });
            return await response.json();
        }

        // Utility functions
        function formatAvailabilityResponse(slots, carer, date) {
            if (slots.length === 0) {
                return "No time slots found. You may need to initialize the system first.";
            }

            const freeSlots = slots.filter(slot => slot.availability === 'Free');
            const bookedSlots = slots.filter(slot => slot.availability === 'Booked');

            let response = `I found ${slots.length} time slots`;
            if (carer) response += ` for ${carer}`;
            if (date) response += ` on ${formatDate(date)}`;
            response += `. `;

            response += `${freeSlots.length} slots are available and ${bookedSlots.length} are booked.`;

            if (freeSlots.length > 0) {
                response += ` Available times include: `;
                const firstFew = freeSlots.slice(0, 3).map(slot => formatTime(slot.time_slot));
                response += firstFew.join(', ');
                if (freeSlots.length > 3) {
                    response += ` and ${freeSlots.length - 3} more slots.`;
                }
            }

            return response;
        }

        function formatTime(timeSlot) {
            const hour = parseInt(timeSlot.substring(0, 2));
            const minute = timeSlot.substring(2);
            const ampm = hour >= 12 ? 'PM' : 'AM';
            const displayHour = hour > 12 ? hour - 12 : (hour === 0 ? 12 : hour);
            return `${displayHour}:${minute} ${ampm}`;
        }

        function formatDate(dateStr) {
            const year = dateStr.substring(0, 4);
            const month = dateStr.substring(4, 6);
            const day = dateStr.substring(6, 8);
            const date = new Date(year, month - 1, day);
            return date.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
        }

        function speakResponse(text) {
            if (synthesis.speaking) {
                synthesis.cancel();
            }

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = parseFloat(document.getElementById('speechRate').value);
            utterance.pitch = parseFloat(document.getElementById('speechPitch').value);
            
            synthesis.speak(utterance);
        }

        function speakCommand(command) {
            addToConversation('user', command);
            processVoiceCommand(command);
        }

        function clearConversation() {
            document.getElementById('conversation').innerHTML = '';
            conversation = [];
        }

        function toggleSettings() {
            const settings = document.getElementById('settings');
            settings.classList.toggle('hidden');
        }

        function showError(message) {
            const statusDiv = document.createElement('div');
            statusDiv.className = 'error';
            statusDiv.textContent = message;
            document.querySelector('.voice-section').appendChild(statusDiv);
            
            setTimeout(() => {
                statusDiv.remove();
            }, 5000);
        }

        async function initializeSystem() {
            try {
                updateStatus('Initializing...', 'Setting up the appointment system');
                await initializeSlots();
                addToConversation('system', 'System initialized successfully! All time slots are now available for booking.');
                updateStatus('System Ready', 'All time slots initialized and ready for use');
            } catch (error) {
                showError(`Initialization failed: ${error.message}`);
            }
        }

        // Settings event listeners
        document.getElementById('speechRate').addEventListener('input', (e) => {
            document.getElementById('speedValue').textContent = `${e.target.value}x`;
        });

        document.getElementById('speechPitch').addEventListener('input', (e) => {
            document.getElementById('pitchValue').textContent = e.target.value;
        });

        document.getElementById('languageSelect').addEventListener('change', (e) => {
            if (recognition) {
                recognition.lang = e.target.value;
            }
        });

        // Initialize when page loads
        window.onload = function() {
            initializeSpeechRecognition();
            updateStatus('Voice Assistant Ready', 'Click the microphone or use quick commands to get started');
        };
    </script>
</body>
</html>
